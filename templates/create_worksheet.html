{% extends "base.html" %}

{% block content %}
<h2>Create New Worksheet</h2>
<form id="worksheetForm">
    <div class="mb-3">
        <label for="title" class="form-label">Title</label>
        <input type="text" class="form-control" id="title" name="title" required>
    </div>
    <div class="mb-3">
        <label for="subject" class="form-label">Subject</label>
        <input type="text" class="form-control" id="subject" name="subject" required>
    </div>
    <div class="mb-3">
        <label for="grade_level" class="form-label">Grade Level</label>
        <input type="text" class="form-control" id="grade_level" name="grade_level" required>
    </div>
    <div class="mb-3">
        <label for="topic" class="form-label">Topic</label>
        <input type="text" class="form-control" id="topic" name="topic" required>
    </div>
    <div class="mb-3">
        <label for="template" class="form-label">Template</label>
        <select class="form-select" id="template" name="template_id" required>
            <option value="">Select a template</option>
            {% for template in templates %}
            <option value="{{ template.id }}">{{ template.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="content" class="form-label">Content</label>
        <textarea class="form-control" id="content" name="content" rows="10" required></textarea>
    </div>
    <div class="mb-3">
        <button type="button" id="generateAIQuestions" class="btn btn-secondary">Generate AI Questions</button>
    </div>
    <div id="aiGeneratedQuestions" class="mb-3" style="display: none;">
        <h4>AI Generated Questions:</h4>
        <ul id="questionList" class="list-group"></ul>
        <button type="button" id="addAIQuestions" class="btn btn-primary mt-2">Add to Worksheet</button>
    </div>
    <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="save_as_template" name="save_as_template">
        <label class="form-check-label" for="save_as_template">Save as a new template</label>
    </div>
    <div class="mb-3" id="template_name_container" style="display: none;">
        <label for="template_name" class="form-label">Template Name</label>
        <input type="text" class="form-control" id="template_name" name="template_name">
    </div>
    <button type="submit" class="btn btn-primary">Create Worksheet</button>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const worksheetForm = document.getElementById('worksheetForm');
    const templateSelect = document.getElementById('template');
    const contentTextarea = document.getElementById('content');
    const saveAsTemplateCheckbox = document.getElementById('save_as_template');
    const templateNameContainer = document.getElementById('template_name_container');
    const generateAIQuestionsBtn = document.getElementById('generateAIQuestions');
    const aiGeneratedQuestions = document.getElementById('aiGeneratedQuestions');
    const questionList = document.getElementById('questionList');
    const addAIQuestionsBtn = document.getElementById('addAIQuestions');

    saveAsTemplateCheckbox.addEventListener('change', function() {
        templateNameContainer.style.display = this.checked ? 'block' : 'none';
    });

    templateSelect.addEventListener('change', function() {
        const selectedTemplateId = this.value;
        if (selectedTemplateId) {
            fetch(`/get_template/${selectedTemplateId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        contentTextarea.value = data.content;
                    } else {
                        console.error('Failed to load template content');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        } else {
            contentTextarea.value = '';
        }
    });

    generateAIQuestionsBtn.addEventListener('click', function() {
        const subject = document.getElementById('subject').value;
        const gradeLevel = document.getElementById('grade_level').value;
        const topic = document.getElementById('topic').value;

        if (!subject || !gradeLevel || !topic) {
            alert('Please fill in the subject, grade level, and topic fields before generating AI questions.');
            return;
        }

        fetch('/generate_ai_questions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                subject: subject,
                grade_level: gradeLevel,
                topic: topic,
                num_questions: 5
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.questions) {
                questionList.innerHTML = '';
                data.questions.forEach(question => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = question;
                    questionList.appendChild(li);
                });
                aiGeneratedQuestions.style.display = 'block';
            } else {
                alert('Failed to generate AI questions. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while generating AI questions');
        });
    });

    addAIQuestionsBtn.addEventListener('click', function() {
        const questions = Array.from(questionList.children).map(li => li.textContent);
        const formattedQuestions = questions.join('\n\n');
        contentTextarea.value += (contentTextarea.value ? '\n\n' : '') + formattedQuestions;
        aiGeneratedQuestions.style.display = 'none';
    });

    worksheetForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('/create_worksheet', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Worksheet created successfully!');
                window.location.href = '/dashboard';
            } else {
                alert('Failed to create worksheet. ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while creating the worksheet');
        });
    });
});
</script>
{% endblock %}
